<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Brject - ログイン</title>
  <script type="module">
    // Firebase SDK 読み込み
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } 
      from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // Firebase 設定
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "brject-3c32c.firebaseapp.com",
      projectId: "brject-3c32c",
      storageBucket: "brject-3c32c.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // 初期化
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 新規登録
    document.getElementById('signup-btn').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        console.log("新規ユーザー登録:", userCredential.user.uid);
        await saveInitialData(userCredential.user.uid, email);
        alert("初期設定が完了しました！");
      } catch (error) {
        console.error("登録エラー:", error.message);
        alert(error.message);
      }
    });

    // ログイン
    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log("ログイン成功:", userCredential.user.uid);
        await checkUserData(userCredential.user.uid);
      } catch (error) {
        console.error("ログインエラー:", error.message);
        alert(error.message);
      }
    });

    // 初期データ保存（初回ログイン時のみ）
    async function saveInitialData(uid, email) {
      const userRef = doc(db, "users", uid);
      await setDoc(userRef, {
        email: email,
        createdAt: new Date(),
        level: 1,
        coins: 0
      });
    }

    // Firestore データ確認
    async function checkUserData(uid) {
      const userRef = doc(db, "users", uid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        console.log("既存データ:", snap.data());
        alert("ログイン完了。ようこそ " + snap.data().email);
      } else {
        await saveInitialData(uid, auth.currentUser.email);
      }
    }

    // 状態監視
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("ログイン済:", user.uid);
      }
    });
  </script>
</head>
<body>
  <h1>Brject</h1>
  <input type="email" id="email" placeholder="メールアドレス">
  <input type="password" id="password" placeholder="パスワード">
  <button id="signup-btn">新規登録</button>
  <button id="login-btn">ログイン</button>
</body>
</html>
